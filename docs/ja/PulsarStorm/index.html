<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript">
  var shiftWindow = function() { scrollBy(0, -108) };
  window.addEventListener("hashchange", shiftWindow);
  window.addEventListener("pageshow", shiftWindow);
  function load() { if (window.location.hash) shiftWindow(); }
</script>

<title>Apache StormのためのPulsarアダプタ</title>

<link rel="stylesheet" href="/incubator-pulsar/css/style.css">
<link rel="shortcut icon" href="/incubator-pulsar/img/favicon.ico">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="/incubator-pulsar/js/jquery.tocify.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

<script async src="/incubator-pulsar/js/main.js"></script>

  </head>
  <body class="body">
    <main class="main">
      <header class="container-fluid sticky-top top-nav">
        <nav class="navbar navbar-default navbar-toggleable-xl container">
  <a class="navbar-brand" href="/incubator-pulsar">
    <img src="/incubator-pulsar/img/pulsar-logo.png">
  </a>

  <div class="collapse navbar-collapse justify-content-end" id="nav-content">
    <ul class="nav navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/docs">Docs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/javadoc">Java</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/api/cpp">C++</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/api/python">Python</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/incubator-pulsar/ja"><img class="japan-flag" src="/incubator-pulsar/img/japan-flag.svg"></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/yahoo/pulsar"><i class="fa fa-github fa-lg"></i></a>
      </li>
      <li class="nav-item version">
        <a class="nav-link">Pulsar 1.17.5</a>
      </li>
    </ul>

  </div>
</nav>

      </header>

      <main>
        <div class="docs-container container-fluid">
  <div class="row">
    <nav class="sidebar-nav col-sm-3 col-lg-3">
      <ul class="sidebar">
  
  <section class="sidebar-group">
    <h4>Getting started</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/GettingStarted/"><i class="fa fa-file-text-o"></i>Pulsar入門</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/Architecture/"><i class="fa fa-file-text-o"></i>システム概要</a></li>
      
      
    </ul>
  </section>
  
  <section class="sidebar-group">
    <h4>運用管理</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/ClusterSetup/"><i class="fa fa-file-text-o"></i>クラスタのセットアップ</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/AdminInterface/"><i class="fa fa-file-text-o"></i>adminツールとAPI</a></li>
      
      
    </ul>
  </section>
  
</ul>

    </nav>

    <article class="col-sm-7 col-lg-7">
      <section class="docs-header">
        <h1 class="docs-title">Apache StormのためのPulsarアダプタ</h1>
        
        <hr />
      </section>

      <section class="content">
        <!-- TOC depthFrom:2 depthTo:3 withLinks:1 updateOnSave:1 orderedList:0 -->

<ul>
  <li><a href="#概要">概要</a></li>
  <li><a href="#pulsar-stormアダプタの利用">Pulsar Stormアダプタの利用</a>
    <ul>
      <li><a href="#pulsar-spout">Pulsar Spout</a></li>
      <li><a href="#pulsar-bolt">Pulsar Bolt</a></li>
    </ul>
  </li>
  <li><a href="#実装例">実装例</a></li>
</ul>

<!-- /TOC -->

<h2 id="概要">概要</h2>
<p>Pulsar StormはApache Storm Topologyと連携するためのアダプタであり、データの送受信を行うためのStromの実装を提供します。</p>

<p>アプリケーションはPulsar Spoutを通してStorm Topologyにデータを注入したり、Pulsar Boltを通してStorm Topologyからデータを取り出すことができます。</p>

<h2 id="pulsar-stormアダプタの利用">Pulsar Stormアダプタの利用</h2>
<p>Pulsar Stormアダプタの依存をincludeします:</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.yahoo.pulsar<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>pulsar-storm<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${pulsar.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<h2 id="pulsar-spout">Pulsar Spout</h2>
<p>Pulsar Spoutを使って、Storm Topologyは<a href="Architecture.md#トピック">Pulsarのトピック</a>に発行されたデータをconsumeできます。Pulsar Spoutは受信したメッセージとクライアントが提供するMessageToValuesMapperをもとにStorm Tupleを発行します。</p>

<p>下流のBoltでの処理に失敗したTupleはSpoutから再注入されます。この再注入は指数バックオフアルゴリズムに従い、設定可能なタイムアウト (デフォルト: 60秒) または設定可能なリトライ回数のどちらかに達するまで行われます。その後、Consumerにより処理成功の応答が返されます。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Pulsarクライアントの設定</span>
<span class="n">ClientConfiguration</span> <span class="n">clientConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClientConfiguration</span><span class="o">();</span>

<span class="c1">// Pulsar Consumerの設定</span>
<span class="n">ConsumerConfiguration</span> <span class="n">consumerConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerConfiguration</span><span class="o">();</span>  

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
<span class="n">MessageToValuesMapper</span> <span class="n">messageToValuesMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageToValuesMapper</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Values</span> <span class="nf">toValues</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getData</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 出力フィールドを宣言</span>
        <span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"string"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">};</span>

<span class="c1">// Pulsar Spoutの設定</span>
<span class="n">PulsarSpoutConfiguration</span> <span class="n">spoutConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PulsarSpoutConfiguration</span><span class="o">();</span>
<span class="n">spoutConf</span><span class="o">.</span><span class="na">setServiceUrl</span><span class="o">(</span><span class="s">"http://broker.messaging.usw.example.com:8080"</span><span class="o">);</span>
<span class="n">spoutConf</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="s">"persistent://my-property/usw/my-ns/my-topic1"</span><span class="o">);</span>
<span class="n">spoutConf</span><span class="o">.</span><span class="na">setSubscriptionName</span><span class="o">(</span><span class="s">"my-subscriber-name1"</span><span class="o">);</span>
<span class="n">spoutConf</span><span class="o">.</span><span class="na">setMessageToValuesMapper</span><span class="o">(</span><span class="n">messageToValuesMapper</span><span class="o">);</span>

<span class="c1">// Pulsar Spoutの作成</span>
<span class="n">PulsarSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PulsarSpout</span><span class="o">(</span><span class="n">spoutConf</span><span class="o">,</span> <span class="n">clientConf</span><span class="o">,</span> <span class="n">consumerConf</span><span class="o">);</span>
</code></pre>
</div>

<h2 id="pulsar-bolt">Pulsar Bolt</h2>
<p>Pulsar Boltを使って、Storm Topology内のデータを<a href="Architecture.md#トピック">Pulsarのトピック</a>に発行できます。Pulsar Boltは受信したStorm Tupleとクライアントが提供するTupleToMessageMapperをもとにメッセージを発行します。</p>

<p>異なるトピックのメッセージを発行するためにパーティションドトピックを利用できます。その場合TupleToMessageMapperの実装において、メッセージに「キー」を用意する必要があります。同じキーを持つメッセージは同じトピックに送信されるようになります。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Pulsarクライアントの設定</span>
<span class="n">ClientConfiguration</span> <span class="n">clientConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClientConfiguration</span><span class="o">();</span>

<span class="c1">// Pulsar Producerの設定  </span>
<span class="n">ProducerConfiguration</span> <span class="n">producerConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProducerConfiguration</span><span class="o">();</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
<span class="n">TupleToMessageMapper</span> <span class="n">tupleToMessageMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TupleToMessageMapper</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Message</span> <span class="nf">toMessage</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">tuple</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">receivedMessage</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// メッセージを処理</span>
        <span class="n">String</span> <span class="n">processedMsg</span> <span class="o">=</span> <span class="n">receivedMessage</span> <span class="o">+</span> <span class="s">"-processed"</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">MessageBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">setContent</span><span class="o">(</span><span class="n">processedMsg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 出力フィールドを宣言</span>
    <span class="o">}</span>
<span class="o">};</span>

<span class="c1">// Pulsar Boltの設定</span>
<span class="n">PulsarBoltConfiguration</span> <span class="n">boltConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PulsarBoltConfiguration</span><span class="o">();</span>
<span class="n">boltConf</span><span class="o">.</span><span class="na">setServiceUrl</span><span class="o">(</span><span class="s">"http://broker.messaging.usw.example.com:8080"</span><span class="o">);</span>
<span class="n">boltConf</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="s">"persistent://my-property/usw/my-ns/my-topic2"</span><span class="o">);</span>
<span class="n">boltConf</span><span class="o">.</span><span class="na">setTupleToMessageMapper</span><span class="o">(</span><span class="n">tupleToMessageMapper</span><span class="o">);</span>

<span class="c1">// Pulsar Boltの作成</span>
<span class="n">PulsarBolt</span> <span class="n">bolt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PulsarBolt</span><span class="o">(</span><span class="n">boltConf</span><span class="o">,</span> <span class="n">clientConf</span><span class="o">);</span>
</code></pre>
</div>

<h2 id="実装例">実装例</h2>
<p>完全な実装の例は<a href="../../../pulsar-storm/src/test/java/com/yahoo/pulsar/storm/example/StormExample.java">StormExample.java</a>を参照してください。</p>

      </section>
    </article>

    <nav class="toc-bar col-sm-2 col-lg-2">
      <div id="toc"></div>
    </nav>
  </div>
</div>

      </main>
    </main>

    <footer class="footer">
  <div class="container">
    <p class="text-center">&copy; Apache Foundation 2017</p>
  </div>
</footer>


    
  </body>
</html>
